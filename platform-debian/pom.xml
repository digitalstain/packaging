<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<artifactId>parent-pom</artifactId>
		<groupId>org.neo4j</groupId>
		<version>18</version>
	</parent>

	<groupId>org.neo4j</groupId>
	<artifactId>platform-debian</artifactId>
	<version>1.5-SNAPSHOT</version>
	<packaging>pom</packaging>

	<name>Neo4j Debian Distribution</name>
	<description>Debian specific distributions of the Neo4j Server</description>

	<url>http://components.neo4j.org/${project.artifactId}/${project.version}</url>

  <scm>
    <connection>scm:git:git://github.com/neo4j/packaging.git</connection>
    <developerConnection>scm:git:git@github.com:neo4j/packaging.git</developerConnection>
    <url>https://github.com/neo4j/packaging</url>
  </scm>

	<properties>
    <short-name>platform-debian</short-name>
		<neo4j.version>1.5-SNAPSHOT</neo4j.version>
		
		<neo4j.debian.maintainer>Anders Nawroth &lt;anders@neotechnology.com&gt;</neo4j.debian.maintainer>
		
		<!-- Change to "stable" when doing a stable release -->
		<neo4j.debian.stability>unstable</neo4j.debian.stability>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.neo4j.assembly</groupId>
			<artifactId>neo4j-standalone</artifactId>
			<version>${neo4j.version}</version>
			<classifier>unix</classifier>
			<type>tar.gz</type>
		</dependency>
	</dependencies>

	<pluginRepositories>
		<pluginRepository>
			<!-- Needed for maven-dependency-plugin 2.2-SNAPSHOT -->
			<id>apache.snapshots</id>
			<url>http://repository.apache.org/snapshots/</url>
		</pluginRepository>
	</pluginRepositories>


	<build>

		<resources>
			<resource>
				<directory>src/main/resources</directory>
				<filtering>true</filtering>
			</resource>
		</resources>

		<plugins>
      <plugin>
        <groupId>org.scala-tools</groupId>
        <artifactId>maven-scala-plugin</artifactId>
        <executions>
          <execution>
            <phase>generate-resources</phase>
            <goals>
              <goal>script</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <script>
            // Convert the current neo4j version to something debian can eat
            
          	var version = project("project.version")
          	
          	if(version.matches("\\d\\.\\d(\\.\\d)?")) {
          	  project.update("neo4j.debian.stability", "stable")
          	} else {
          	  project.update("neo4j.debian.stability", "unstable")
          	}
          	
          	// Debian does not allow hyphens
          	project.update("neo4j.debian.version", version.replace("-","."))
          	
          	import java.util.Date 
            import java.text.MessageFormat 
            project.update("neo4j.debian.buildDate", MessageFormat.format("{0,date,EEE, dd MMM yyyy HH:mm:ss Z}", new Date()))
         </script>
        </configuration>
      </plugin>

			<plugin>
				<artifactId>maven-resources-plugin</artifactId>
				<executions>
					<execution>
						<phase>process-resources</phase>
						<goals>
							<goal>resources</goal>
						</goals>
					</execution>
				</executions>
			</plugin>

			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>
				<version>2.2</version>
				<executions>
					<execution>
						<id>unpack</id>
						<phase>process-resources</phase>
						<goals>
							<goal>copy</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<groupId>org.neo4j.assembly</groupId>
									<artifactId>neo4j-standalone</artifactId>
									<classifier>unix</classifier>
									<type>tar.gz</type>
									<outputDirectory>${project.build.outputDirectory}</outputDirectory>
									<includes>**/*</includes>
								</artifactItem>
							</artifactItems>
						</configuration>
					</execution>
				</executions>
			</plugin>

			<!-- Trigger debuild to create .deb package -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-antrun-plugin</artifactId>
				<version>1.6</version>

				<executions>
					<execution>
						<phase>package</phase>
						<goals>
							<goal>run</goal>
						</goals>
						<configuration>
							<target>
							  <untar src="${project.build.outputDirectory}/neo4j-standalone-${neo4j.version}-unix.tar.gz"
							         dest="${project.build.outputDirectory}"
							         compression="gzip" />
							         
							  <!-- COMMUNITY -->
								
								<copy toDir="${project.build.outputDirectory}/community/debian">
								    <fileset dir="${project.build.outputDirectory}/debian" includes="**" />
								</copy>
								
								<move file="${project.build.outputDirectory}/neo4j-community-${neo4j.version}" 
								    toFile="${project.build.outputDirectory}/community/server" />
								
								<exec executable="debuild" dir="${project.build.outputDirectory}/community">
									<arg line="-us" />
									<arg line="-uc" />
									<arg line="-B" />
								</exec>
							</target>
						</configuration>
					</execution>
				</executions>
			</plugin>
		</plugins>
	</build>

	<repositories>
		<repository>
		  <id>neo4j-snapshot-repository</id>
		  <name>Publically available Maven 2 repository for Neo4j</name>
		  <url>http://m2.neo4j.org/snapshots</url>
		  <snapshots>
		    <enabled>true</enabled>
		  </snapshots>
		  <releases>
		    <enabled>false</enabled>
		  </releases>
		</repository>
		<repository>
		  <id>neo4j-release-repository</id>
		  <name>Publically available Maven 2 repository for Neo4j</name>
		  <url>http://m2.neo4j.org/releases</url>
		  <snapshots>
		    <enabled>false</enabled>
		  </snapshots>
		  <releases>
		    <enabled>true</enabled>
		  </releases>
		</repository>
	</repositories>

</project>
